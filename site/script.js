// === CONFIGURATION ===
const UBIDOTS_TOKEN = "BBUS-AoGq5fswhdE5DvDQv670osyzoGLAsY";
const DEVICE = "BinGo";
const NGROK_API_URL = "https://f8b2-79-174-206-181.ngrok-free.app"; // URL de l'API Ubidots via ngrok

const LEVEL_VARS = ["niveau_bac1", "niveau_bac2", "niveau_bac3", "niveau_bac4", "niveau_bac5"];
const WASTE_VARS = ["plastique", "papier_carton", "verre", "metal", "non_recyclable"];

const SPREADSHEET_ID = "1H5oOlzpMnm91YhuOPa82Yi_8R4Vn2gIJLphG5Lt5HSU";
const API_KEY = "AIzaSyAt5tmQzLb91C7SgmYozzOLh72XmCNbxpc";
const SHEET_NAME = "Feuille 1";

const NGROK_HEADERS = {
    'ngrok-skip-browser-warning': 'true',
    'Content-Type': 'application/json'
};
// Ic√¥nes et labels
const WASTE_CONFIG = {
    "plastique": { icon: "üß¥", label: "Plastique" },
    "papier_carton": { icon: "üìÑ", label: "Papier/Carton" },
    "verre": { icon: "üçæ", label: "Verre" },
    "metal": { icon: "ü•´", label: "M√©tal" },
    "non_recyclable": { icon: "üóëÔ∏è", label: "Non recyclable" }
};

// Variables globales
let isUsingMockData = false;

// Initialisation de l'affichage
function initDisplay() {
    initBins();
    initStats();
}

function initBins() {
    const binsContainer = document.getElementById('bins');
    binsContainer.innerHTML = LEVEL_VARS.map((_, i) => `
    <div class="bin" id="bin-${i}">
      <div class="bin-label" id="label-${i}">üóëÔ∏è Bac ${i + 1} : 0%</div>
      <div class="progress">
        <div class="progress-bar" id="bar-${i}" style="width:0%">0%</div>
      </div>
    </div>
  `).join('');
}

function initStats() {
    const statsContainer = document.getElementById('stats');
    statsContainer.innerHTML = WASTE_VARS.map((waste, i) => `
    <div class="stat-item" id="stat-${i}">
      <div class="stat-icon">${WASTE_CONFIG[waste].icon}</div>
      <div class="stat-info">
        <div class="stat-label">${WASTE_CONFIG[waste].label}</div>
        <div class="stat-value" id="stat-value-${i}">0</div>
      </div>
    </div>
  `).join('');
}

// Fonction pour r√©cup√©rer les donn√©es depuis ton API Flask
async function fetchAllData() {
    let totalWaste = 0;
    isUsingMockData = false;

    try {
        // R√©cup√©ration des donn√©es depuis ton API Flask
        const res = await fetch(`${NGROK_API_URL}/api/data`, {
            headers: NGROK_HEADERS
        });

        if (res.ok) {
            const data = await res.json();
            console.log("Donn√©es re√ßues:", data);

            // Mise √† jour des niveaux des bacs
            for (let i = 0; i < LEVEL_VARS.length; i++) {
                const level = data[LEVEL_VARS[i]] || 0;
                updateBinDisplay(i, level);
            }

            // Pour les statistiques, utilise les donn√©es d'historique si disponibles
            await fetchWasteStats();

        } else {
            console.error("Erreur API:", res.status);
            useMockData();
        }
    } catch (error) {
        console.error("Erreur connexion API:", error);
        useMockData();
    }

    updateStatus();
}

// R√©cup√©rer les statistiques depuis l'historique
async function fetchWasteStats() {
    try {
        const res = await fetch(`${NGROK_API_URL}/api/history`, {
            headers: NGROK_HEADERS
        });

        if (res.ok) {
            const history = await res.json();
           
            // Compter les types de d√©chets depuis l'historique
            // (Tu devras adapter selon la structure de tes donn√©es d'historique)
            const wasteCounts = {
                "plastique": Math.floor(Math.random() * 50),
                "papier_carton": Math.floor(Math.random() * 50),
                "verre": Math.floor(Math.random() * 50),
                "metal": Math.floor(Math.random() * 50),
                "non_recyclable": Math.floor(Math.random() * 50)
            };

            // Mise √† jour de l'affichage des statistiques
            let totalWaste = 0;
            WASTE_VARS.forEach((waste, i) => {
                const count = wasteCounts[waste] || 0;
                totalWaste += count;
                updateStatDisplay(i, count);
            });

            document.getElementById('totalWaste').textContent = `Total d√©chets: ${totalWaste}`;
        }
    } catch (error) {
        console.error("Erreur r√©cup√©ration statistiques:", error);
    }
}

// Fonction de fallback en cas d'erreur
function useMockData() {
    isUsingMockData = true;
   
    // Donn√©es simul√©es pour les bacs
    for (let i = 0; i < LEVEL_VARS.length; i++) {
        updateBinDisplay(i, getRandomLevel());
    }
   
    // Donn√©es simul√©es pour les statistiques
    let totalWaste = 0;
    for (let i = 0; i < WASTE_VARS.length; i++) {
        const count = getRandomWasteCount();
        totalWaste += count;
        updateStatDisplay(i, count);
    }
   
    document.getElementById('totalWaste').textContent = `Total d√©chets: ${totalWaste}`;
}

// Tester la connexion √† l'API
async function testConnection() {
    try {
        const res = await fetch(`${NGROK_API_URL}/api/status`, {
            headers: NGROK_HEADERS
        });
       
        if (res.ok) {
            const status = await res.json();
            console.log("Statut API:", status);
            return true;
        }
    } catch (error) {
        console.error("Test connexion √©chou√©:", error);
    }
    return false;
}

function getRandomLevel() {
    return Math.floor(Math.random() * 100);
}

function getRandomWasteCount() {
    return Math.floor(Math.random() * 50);
}

// Mise √† jour de l'affichage
function updateBinDisplay(index, value) {
    const label = document.getElementById(`label-${index}`);
    const bar = document.getElementById(`bar-${index}`);

    if (label && bar) {
        label.textContent = `üóëÔ∏è Bac ${index + 1} : ${value}%`;
        bar.style.width = `${value}%`;
        bar.textContent = `${value}`;

        bar.style.backgroundColor = value >= 95 ? "#e53935" :
            value >= 60 ? "#ff9800" : "#4caf50";
    }
}

function updateStatDisplay(index, count) {
    const statValue = document.getElementById(`stat-value-${index}`);
    if (statValue) statValue.textContent = count;
}

function updateStatus() {
    const now = new Date();
    const statusElement = document.getElementById('updateStatus');

    if (statusElement) {
        if (isUsingMockData) {
            statusElement.textContent = `‚ö† Connexion API √©chou√©e - Donn√©es simul√©es - ${now.toLocaleString()}`;
            statusElement.className = 'update-status error';
        } else {
            statusElement.textContent = `‚úì Donn√©es temps r√©el via ngrok - ${now.toLocaleString()}`;
            statusElement.className = 'update-status success';
        }
    }
}

// === NOTIFICATIONS GOOGLE SHEETS ===
async function fetchNotifications() {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
    const notifContent = document.getElementById("notifContent");

    try {
        const response = await fetch(url);
        const data = await response.json();
        const rows = data.values;

        notifContent.innerHTML = rows.length > 1
            ? rows.slice(1).reverse().slice(0, 10).map(row => `
                <p>üì© ${row[0]} a atteint ${row[1]}% √† ${row[2]}</p>
            `).join('')
            : "<p>Aucune notification trouv√©e</p>";

    } catch (error) {
        console.error("Erreur notifications :", error);
        notifContent.innerHTML = "<p>Erreur lors de la r√©cup√©ration des notifications.</p>";
    }
}

function displayLog() {
    document.getElementById("notifLog").style.display = "block";
    document.getElementById("shadow").style.display = "block";

    fetchNotifications(); // Rafra√Æchit les notifications √† chaque ouverture
}

function hideLog() {
    document.getElementById("notifLog").style.display = "none";
    document.getElementById("shadow").style.display = "none";
}

// Initialisation au chargement
document.addEventListener('DOMContentLoaded', async () => {
    initDisplay();

     // Tester la connexion avant de commencer
    const connected = await testConnection();
    if (connected) {
        console.log("‚úÖ Connexion API √©tablie");
    } else {
        console.log("‚ö†Ô∏è API non accessible, mode simulation");
    }

    fetchAllData();

    // Mise √† jour toutes les 5 secondes
    setInterval(fetchAllData, 5000);
});